<Window x:Class="PortProcessManager.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:PortProcessManager"
        xmlns:viewModels="clr-namespace:PortProcessManager.ViewModels"
        xmlns:converters="clr-namespace:PortProcessManager.Converters"
        mc:Ignorable="d"
        Title="Windows 端口管理器" Height="720" Width="1060"
        Background="White"
        Icon="/icon.ico">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:CountToVisibilityConverter x:Key="CountToVis"/>
        <converters:BooleanToExpandCollapseTextConverter x:Key="ExpandCollapseText"/>
        <local:BindingProxy x:Key="DataContextProxy" Data="{Binding}"/>
    </Window.Resources>

    <Window.DataContext>
        <viewModels:MainViewModel />
    </Window.DataContext>

    <DockPanel LastChildFill="True" Margin="16">
        <Border DockPanel.Dock="Top" Background="#F7F7F7" CornerRadius="8" Padding="12" Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="端口进程管理器" FontSize="18" FontWeight="SemiBold" Foreground="#1A1A1A" VerticalAlignment="Center"/>
                    <TextBlock Text="(管理员)" Margin="8,0,0,0" Foreground="#666" VerticalAlignment="Center" FontSize="12"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <CheckBox Content="按进程分组" 
                              IsChecked="{Binding IsGrouped}" 
                              VerticalAlignment="Center" 
                              Margin="0,0,16,0"/>
                    <Button Content="{Binding AreGroupsExpanded, Converter={StaticResource ExpandCollapseText}}"
                            Command="{Binding ToggleGroupsExpansionCommand}"
                            Visibility="{Binding IsGrouped, Converter={StaticResource BoolToVis}}"
                            Margin="0,0,16,0"
                            Padding="8,0"
                            Height="24"
                            FontSize="11"/>
                    <CheckBox Content="自动刷新 (5s)" 
                              IsChecked="{Binding IsAutoRefreshEnabled}" 
                              VerticalAlignment="Center" 
                              Margin="0,0,16,0"/>
                    <TextBox Width="260" Height="32" Margin="0,0,12,0"
                             VerticalContentAlignment="Center"
                             Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}" />
                    <Button Height="32" MinWidth="96" Padding="14,0"
                            Command="{Binding RefreshCommand}"
                            Content="刷新"/>
                </StackPanel>
            </Grid>
        </Border>

        <Border Background="#FFFFFF" CornerRadius="8" BorderBrush="#E5E5E5" BorderThickness="1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="#FFFFFF" Padding="12" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                            <!-- 统计信息移至此处 -->
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="总连接: " Foreground="#999"/>
                                <TextBlock Text="{Binding TotalConnections}" FontWeight="Bold" Foreground="#333"/>
                                <TextBlock Text="  TCP: " Margin="12,0,0,0" Foreground="#999"/>
                                <TextBlock Text="{Binding TcpCount}" FontWeight="Bold" Foreground="#333"/>
                                <TextBlock Text="  UDP: " Margin="12,0,0,0" Foreground="#999"/>
                                <TextBlock Text="{Binding UdpCount}" FontWeight="Bold" Foreground="#333"/>
                                <TextBlock Text="  进程: " Margin="12,0,0,0" Foreground="#999"/>
                                <TextBlock Text="{Binding ProcessCount}" FontWeight="Bold" Foreground="#333"/>
                            </StackPanel>
                        </StackPanel>
                        <TextBlock Text="{Binding StatusText}" Foreground="#666" VerticalAlignment="Center" HorizontalAlignment="Right"/>
                    </DockPanel>
                </Border>

                <Grid Grid.Row="1">
                    <DataGrid x:Name="MainGrid"
                              ItemsSource="{Binding ItemsView}"
                              SelectedItem="{Binding SelectedItem}"
                              SelectionMode="Extended"
                              IsReadOnly="True"
                              HeadersVisibility="Column"
                              AutoGenerateColumns="False">
                        <DataGrid.GroupStyle>
                            <GroupStyle>
                                <GroupStyle.ContainerStyle>
                                    <Style TargetType="{x:Type GroupItem}">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="{x:Type GroupItem}">
                                                    <Expander IsExpanded="{Binding DataContext.AreGroupsExpanded, RelativeSource={RelativeSource AncestorType=Window}, Mode=OneWay}"
                                                              Background="#F0F0F0" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
                                                        <Expander.Header>
                                                            <Border Background="Transparent">
                                                                <Border.ContextMenu>
                                                                    <ContextMenu>
                                                                        <MenuItem Header="结束该组进程" 
                                                                                  Command="{Binding Data.KillGroupCommand, Source={StaticResource DataContextProxy}}" 
                                                                                  CommandParameter="{Binding}" />
                                                                    </ContextMenu>
                                                                </Border.ContextMenu>
                                                                <StackPanel Orientation="Horizontal" Margin="4,2">
                                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" VerticalAlignment="Center"/>
                                                                    <TextBlock Text="{Binding ItemCount, StringFormat=' ({0} 个连接)'}" Foreground="#666" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </Expander.Header>
                                                        <ItemsPresenter />
                                                    </Expander>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </GroupStyle.ContainerStyle>
                            </GroupStyle>
                        </DataGrid.GroupStyle>
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="结束选中进程" 
                                          Command="{Binding KillSelectedItemsCommand}" 
                                          CommandParameter="{Binding SelectedItems, RelativeSource={RelativeSource Self}}"
                                          FontWeight="Bold" />
                                <MenuItem Header="打开文件位置" Command="{Binding OpenFileLocationCommand}" />
                                <Separator />
                                <MenuItem Header="复制 PID" Command="{Binding CopyInfoCommand}" CommandParameter="PID" />
                                <MenuItem Header="复制端口" Command="{Binding CopyInfoCommand}" CommandParameter="Port" />
                                <MenuItem Header="复制完整路径" Command="{Binding CopyInfoCommand}" CommandParameter="Path" />
                                <MenuItem Header="批量复制选中行" 
                                          Command="{Binding CopySelectedItemsCommand}" 
                                          CommandParameter="{Binding SelectedItems, RelativeSource={RelativeSource Self}}" />
                                <Separator />
                                <MenuItem Header="刷新" Command="{Binding RefreshCommand}" />
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="协议" Binding="{Binding Protocol}" Width="60" />
                            <DataGridTextColumn Header="本地地址" Binding="{Binding LocalAddress}" Width="*" />
                            <DataGridTextColumn Header="本地端口" Binding="{Binding LocalPort}" Width="80" />
                            <DataGridTextColumn Header="远程地址" Binding="{Binding RemoteAddress}" Width="*" />
                            <DataGridTextColumn Header="远程端口" Binding="{Binding RemotePort}" Width="80" />
                            <DataGridTextColumn Header="状态" Binding="{Binding State}" Width="100">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Style.Triggers>
                                            <Trigger Property="Text" Value="LISTEN">
                                                <Setter Property="Foreground" Value="#0078D4"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Trigger>
                                            <Trigger Property="Text" Value="ESTABLISHED">
                                                <Setter Property="Foreground" Value="#107C10"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="PID" Binding="{Binding Pid}" Width="70" />
                            <DataGridTemplateColumn Header="进程" Width="140" SortMemberPath="ProcessName">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <Image Source="{Binding Icon}" Width="16" Height="16" Margin="0,0,8,0" 
                                                   RenderOptions.BitmapScalingMode="HighQuality"
                                                   SnapsToDevicePixels="True"/>
                                            <TextBlock Text="{Binding ProcessName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="用户" Binding="{Binding Owner}" Width="100" />
                            <DataGridTextColumn Header="路径" Binding="{Binding ProcessPath}" Width="1.5*" />
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- 空状态提示：仅在非忙碌且列表为空时显示 -->
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" 
                                Visibility="{Binding ShowEmptyHint, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="未发现匹配的端口占用" Foreground="#999" FontSize="16"/>
                        <Button Content="立即刷新" Command="{Binding RefreshCommand}" Margin="0,12,0,0" Style="{x:Null}"/>
                    </StackPanel>

                    <Border Background="#33FFFFFF" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" IsHitTestVisible="True">
                        <StackPanel VerticalAlignment="Center">
                            <ProgressBar IsIndeterminate="True" Width="200" Height="4" />
                            <TextBlock Text="正在扫描系统端口..." HorizontalAlignment="Center" Margin="0,8,0,0" Foreground="{StaticResource PrimaryBrush}"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>
        </Border>
    </DockPanel>
</Window>
